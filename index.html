<!DOCTYPE html>
<html lang="en">

<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <meta http-equiv="X-UA-Compatible" content="ie=edge">
 <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
  integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
 <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
 <title>Weather Dashboard</title>
</head>

<body>
 <div class="container">
  <header class="jumbotron">
   <h1>Weather Dashboard</h1>
   <p class="lead">See weather conditions and forecast for any city</p>
   <hr>
  </header>
  <div class="row">
   <div class="col-4">
    <h3>Search</h3>
    <br>
    <form>
     <label for="searchField">Enter City Name</label><br>
     <input type="search" id="search-field" placeholder="example: Seattle"> &nbsp;
     <input type="submit" id="search-button" value="Search"><br>
    </form>
    <br>
    <h3>Search History</h3>
    <ul id="search-history" class="list-group"></ul>
    <button type="button" id="clear-history">Clear History</button>
   </div>
   <div class="col">
    <div class="row">
     <div class="col">
      <h2>Current Weather Conditions</h2>
      <h3 id="city"></h3>
      <h4 id="main-date"></h4>
     </div>
    </div>
    <div class="row">
     <div class="col"></div>
     <div class="col-6">
      <div class="card">
       <img id="main-icon" class="card-img-top">
       <div class="card-body">
        <h3 id="main-temp" class="card-title"></h3>
        <ul class="list-group">
         <li class="list-group-item">
          <strong>Humidity:
           <span id="main-humidity"></span>
          </strong>
         </li>
         <li class="list-group-item">
          <strong>Wind Speed:
           <span id="main-windspeed"></span>
          </strong>
         </li>
         <li class="list-group-item">
          <strong>UV Index:
           <span id="main-uv"></span>
          </strong>
         </li>
        </ul>
       </div>
      </div>
     </div>
     <div class="col"></div>
    </div>
    <div class="row">
     <div class="col">
      <h2>5-Day Forecast</h2>
     </div>
    </div>
   </div>
  </div>
 </div>


 <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
 <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
 <script src="assets/lockr.js"></script>

 <script>
  // Store the Open Weather API key globally so all JS functions can access it
  var appId = "66a22b3ac35b14a53d37aa2c7d5ab149";

  // Main program
  $(document).ready(function () {
   // Display today's date
   $("#main-date").text(moment().format("dddd, MMMM Do"));

   // Load search history
   displaySearchHistory();

   // Search button event handler
   $("#search-button").click(function (event) {
    event.preventDefault();

    var city = $("#search-field").val().trim();
    if (city.length > 0) {
     saveToSearchHistory(city);
     displayCurrentWeather(city);
     $("#search-field").val("");
     displaySearchHistory();
    } else {
     alert("Search field cannot be blank.");
    }
   });

   // Search history links event handler
   $(".history-link").click(function(event) {
    event.preventDefault();

    displayCurrentWeather($(this).text());
   });

   // Clear history button event handler
   $("#clear-history").click(function(event) {
    event.preventDefault();

    Lockr.set("searchHistory", null);
    displaySearchHistory();
   });
  });

  function displayCurrentWeather(city) {
   $.ajax({
    url: "https://api.openweathermap.org/data/2.5/weather?APPID=" + appId + "&q=" + city + "&units=imperial",
    method: "GET"
   }).then(function (response) {
    $("#city").text(response.name);
    var iconSrc = "http://openweathermap.org/img/wn/" + response.weather[0].icon + "@2x.png";
    $("#main-icon").attr("src", iconSrc);
    $("#main-icon").attr("alt", response.weather[0].description);
    $("#main-temp").text(Math.round(response.main.temp) + " F");
    $("#main-humidity").text(response.main.humidity + "%");
    $("#main-windspeed").text(Math.round(response.wind.speed) + " mph");
    displayUvIndex(response.coord.lat, response.coord.lon);
   });
  }

  function displayUvIndex(lat, lon) {
   $.ajax({
    url: "http://api.openweathermap.org/data/2.5/uvi?appid=" + appId + "&lat=" + lat + "&lon=" + lon,
    method: "GET"
   }).then(function (response) {
    $("#main-uv").text(response.value);
   });
  }

  function displaySearchHistory() {
   var searchHistory = Lockr.get("searchHistory");
   if (searchHistory != null) {
    $("#search-history").empty();
    for (var i = 0; i < searchHistory.length; i++) {
     var historyItem = $("<li>").addClass("list-group-item");
     var historyLink = $("<a>").addClass("history-link");
     historyLink.text(searchHistory[i]);
     historyLink.attr("href", "");
     historyItem.append(historyLink);
     $("#search-history").prepend(historyItem);
    }
   } else {
    $("#search-history").append("<strong>").text("No search history");
   }
  }

  function saveToSearchHistory(city) {
   var searchHistory = Lockr.get("searchHistory");
   city = city.toLowerCase();

   if (searchHistory!= null) {
    if (!searchHistory.includes(city)) {
     searchHistory.push(city);
    }
   } else {
    searchHistory = [ city ];
   }
   Lockr.set("searchHistory", searchHistory);
  }
 </script>
</body>

</html>